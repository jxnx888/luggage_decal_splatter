<!DOCTYPE html>
<html lang="en">
<head>
	<title>Imp decal splatter</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="IE=11,chrome=1">
	<link type="text/css" rel="stylesheet" href="../css/main.css">
</head>
<body>
<div class="main_wrapper">
	<div id="decals">
		<div class="top_nav clearfix">
			<div class="map active">Map</div>
			<div class="recent">Recently used</div>
			<!--			<div id="exportASCII">exportASCII</div>-->
		</div>
		<div class="map_decals clearfix" id="map_decals">
			<div class="upload_wrapper clearfix" id="decal_upload">
				<div class="text_ipload">
					<p class="open_upload">+ Upload decal(png)</p>
					<p class="close_upload">+</p>
				</div>
				<input id="upload_input"  name="file" type="file" multiple="false" onchange="uploadMap(this.files)" title="Upload Image Search"/>
			</div>
			<div class="map_wrapper clearfix" id="map_wrapper"></div>
			<div class="recently_wrapper clearfix" id="recently_wrapper">
				<div class="no_recently">No recently used decals!</div>
			</div>
		</div>
		<div class="show_more"><img src="../img/decal/arrow.png" alt="" width="7" height="14"></div>
	</div>
	<div id="container"></div>

	<div id="info">
		Imp decal splatter
		<div class="ie_notice">We highly recommend you open current page in Chrome or Firefox.</div>
	</div>
</div>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.3/jquery.lazyload.min.js'></script>
<script src='../js/three.js'></script>
<!--<script src='../js/three.module.js'></script>-->
<script src='../js/STLLoader.js'></script>
<script src='../js/DecalGeometry.js'></script>
<script src='../js/OrbitControls.js'></script>
<script src='../js/dat.gui.min.js'></script>
<script src='../js/STLExporter.js'></script>
<script src='../js/fastclick.js'></script>
<script>
	if(IEVersion()!=-1){
		$(".ie_notice").show();
	}
	function IEVersion() {
		var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
		var isIE = userAgent.indexOf( "compatible" ) > - 1 && userAgent.indexOf( "MSIE" ) > - 1; //判断是否IE<11浏览器
		var isEdge = userAgent.indexOf( "Edge" ) > - 1 && ! isIE; //判断是否IE的Edge浏览器
		var isIE11 = userAgent.indexOf( 'Trident' ) > - 1 && userAgent.indexOf( "rv:11.0" ) > - 1;
		if (isIE) {
			var reIE = new RegExp( "MSIE (\\d+\\.\\d+);" );
			reIE.test( userAgent );
			var fIEVersion = parseFloat( RegExp["$1"] );
			if (fIEVersion == 7) {
				return 7;
			} else if (fIEVersion == 8) {
				return 8;
			} else if (fIEVersion == 9) {
				return 9;
			} else if (fIEVersion == 10) {
				return 10;
			} else {
				return 6;//IE版本<=7
			}
		} else if (isEdge) {
			return 'edge';//edge
		} else if (isIE11) {
			return 11; //IE11
		} else {
			return - 1;//不是ie浏览器
		}
	}
		$(".show_more").click(function (  ) {
		$("#decals").toggleClass("close");
		$(".show_more").toggleClass("show_more_close");
		$(".map").toggleClass("map_btn_close");
		$(".map").trigger("click")
	})
	$(".map").click(function(){
		$("#decals .top_nav div").removeClass("active");
		$("#decals .top_nav .map").addClass("active");
		$("#map_decals #map_wrapper").show();
		$("#map_decals #recently_wrapper").hide();
		$("#decal_upload").show(); //上传显示
	})
	$(".recent").click(function(){
		$("#decals .top_nav div").removeClass("active");
		$("#decals .top_nav .recent").addClass("active");
		$("#map_decals #map_wrapper").hide();
		$("#decal_upload").hide(); //上传隐藏
		$("#map_decals #recently_wrapper").show();
	})
</script>
<script>
	var container = document.getElementById( 'container' );
	var exporter; //文件导出
	var decalMap={}; //贴图arr
	getDecalMap();
	function getDecalMap(){
		var imgPath = '../img/decals/';
		var totalNum = 51;
		for(var i=1;i<totalNum; i++){
			decalMap[i] = imgPath+i+'.png'
		}
		createMap("map_wrapper",decalMap);
	}

	var renderer, scene, camera, stats;
	var mesh;
	var raycaster;
	var line;
	var currentDecal;
	var intersection = {
		intersects: false,
		point: new THREE.Vector3(),
		normal: new THREE.Vector3()
	};
	var mouse = new THREE.Vector2();
	var intersects = [];
	var defaultSTL = '../models/stl/ascii/grey.stl';
	var textureLoader = new THREE.TextureLoader();
	var currentDecal=decalMap[1]; //当前贴图默认第一个
	var decalDiffuse = textureLoader.load( decalMap[1] );
	var decalNormal = textureLoader.load( decalMap[1] );
	var decalMaterial = new THREE.MeshPhongMaterial( {
		specular: 0x444444,
		map: decalDiffuse,
		normalMap: decalNormal,
		normalScale: new THREE.Vector2( 1, 1 ),
		shininess: 30,
		transparent: true,
		depthTest: true,
		depthWrite: false,
		polygonOffset: true,
		polygonOffsetFactor: - 4,
		wireframe: false,
	} );
	var lastShootPostion;
	var lastShootrotation;
	var decals = [];
	var removedDecals = [];
	var currentObj=[];//当前主体 行李箱
	var currentDecalObj=[];//当前主体的decal
	var recentlyUsedDecal= new Array();//使用过的的decal
	var mouseHelper;
	var position = new THREE.Vector3();
	var orientation = new THREE.Euler();
	var size = new THREE.Vector3( 10, 10, 10 );
	var currentSize = new THREE.Vector3( 10, 10, 10 ); //当前鼠标decal的大小
	var currentPosition = new THREE.Vector3(0,0,0);//当前鼠标decal的位置
	var currentmaterial;;//当前鼠标decal的材质
	var dirLight, dirLightHeper, hemiLight, hemiLightHelper;
	var params = {
		SUBMIT:function (){
			exportASCII();
		},
		/*minScale: 10,*/
		maxScale: 30,
		rotation: Math.PI /180, // positive is counter-clockwise   Math.PI = 3.14 = 180°
		back: function () {
			removeLastDecals();
		},
		forward: function () {
			returnLastDecals();
		},
		clear: function () {

			removeDecals();

		}
	};

	window.addEventListener( 'load', init );

	function init( file ) {

		renderer = new THREE.WebGLRenderer( { antialias: true } );
		renderer.setPixelRatio( window.devicePixelRatio );
		renderer.setSize( window.innerWidth, window.innerHeight);
		container.appendChild( renderer.domElement );

		/*stats = new Stats(); //网络帧数
        container.appendChild( stats.dom );*/

		scene = new THREE.Scene();

		// sky + ground
		//sky
		scene.background = new THREE.Color( 0xcce0ff );
		scene.fog = new THREE.Fog( 0xcce0ff, 50, 1000 );
		// ground
		var loaderText = new THREE.TextureLoader();
		var groundTexture = loaderText.load( '../img/grasslight-big.jpg' );
		groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
		groundTexture.repeat.set( 25, 25 );
		groundTexture.anisotropy = 1;
		groundTexture.encoding = THREE.sRGBEncoding;

		var groundMaterial = new THREE.MeshLambertMaterial( { map: groundTexture } );

		var meshGround = new THREE.Mesh( new THREE.PlaneBufferGeometry( 6000, 6000 ), groundMaterial );
		meshGround.position.y = - 50;
		meshGround.rotation.x = - Math.PI / 2;
		meshGround.receiveShadow = true;
		scene.add( meshGround );
		// sky + ground end

		// scene.add( new THREE.AxesHelper( 50 ) ); //坐标位置辅助线 Coordinate system

		// 相机位置距离
		camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
		camera.position.z = 120;
		camera.target = new THREE.Vector3();

		var controls = new THREE.OrbitControls( camera, renderer.domElement );
		controls.minDistance = 50; //设置相机距离原点的最近距离
		controls.maxDistance = 200;//设置相机距离原点的最远距离

		exporter = new THREE.STLExporter(); //导出工具


		// LIGHTS
		scene.add( new THREE.AmbientLight( 0xFFFFFFF,1.2) );//（环境光）

		dirLight = new THREE.DirectionalLight( 0xffffff, .08 ); //正面上
		dirLight.position.set( 0,75, 100 );
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );//光源辅助线
		// scene.add( dirLightHeper );
		scene.add( dirLight );
		dirLight = new THREE.DirectionalLight( 0xffffff, .08 ); //正面下
		dirLight.position.set( 0,-75,100 );
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );//光源辅助线
		// scene.add( dirLightHeper );
		scene.add( dirLight );

		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( 0, 75, -100 ); //背部 上
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );
		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( 0, -75, -100 ); //背部 上
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );

		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( 0, 100, 0 ); //顶部
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );
		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( 100, 0, 0 ); //右侧
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );

		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( 0, -100, 0 ); //底部
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );
		dirLight = new THREE.DirectionalLight( 0xffffff, .18 );
		dirLight.position.set( -100, 0, 0 );//左侧
		// dirLightHeper = new THREE.DirectionalLightHelper( dirLight, 5 );
		// scene.add( dirLightHeper );
		scene.add( dirLight );


		// 鼠标红线
		var geometry = new THREE.BufferGeometry();
		geometry.setFromPoints( [new THREE.Vector3(), new THREE.Vector3()] );

		var lineMaterial = new THREE.LineBasicMaterial( {
			color: 0xFF0000,
			linewidth: 100,
			linecap: 'round',
			linejoin: 'round'
		} );
		line = new THREE.Line( geometry, lineMaterial );
		// scene.add( line ); //鼠标辅助线

		loadSTL(defaultSTL,decals);
		raycaster = new THREE.Raycaster();
		initGUI();//右上角操作栏
		// mouseHelper = new THREE.Mesh( new THREE.BoxBufferGeometry( 1, 1, 0 ), new THREE.MeshNormalMaterial() );
		// mouseHelper.visible = false; //隐藏显示矩形
		// scene.add( mouseHelper );

		window.addEventListener( 'resize', onWindowResize, false );

		var moved = false;

		controls.addEventListener( 'change', function () {

			moved = true;

		} );

		window.addEventListener( 'mousedown', function () {

			moved = false;

		}, false );

		window.addEventListener( 'mouseup', function () {

			checkIntersection();
			if (! moved && intersection.intersects) shoot(0);

		} );

		window.addEventListener( 'mousemove', onTouchMove );
		window.addEventListener( 'touchmove', onTouchMove );


		onWindowResize();
		animate(); //render 等

	}
	function onTouchMove( event ) {

		var x, y;

		if (event.changedTouches) {

			x = event.changedTouches[0].pageX;
			y = event.changedTouches[0].pageY;

		} else {

			x = event.clientX;
			y = event.clientY;

		}

		mouse.x = ( x / window.innerWidth ) * 2 - 1;
		mouse.y = - ( y / window.innerHeight ) * 2 + 1;
		checkIntersection();

	}

	function checkIntersection() {

		if (! mesh) return;

		raycaster.setFromCamera( mouse, camera );
		raycaster.intersectObject( mesh, false, intersects );

		if (intersects.length > 0) {

			var p = intersects[0].point;
			mouseHelper.position.copy( p );
			intersection.point.copy( p );
			/*1.克隆旧的法线 2.旧法线乘以模型的世界矩阵得到归一化后的法线 3.和一个标量相乘，放大10倍。 4.加上点击点的坐标，进行平移。*/
			var n = intersects[0].face.normal.clone();
			n.transformDirection( mesh.matrixWorld );
			n.multiplyScalar( 10 );
			n.add( intersects[0].point );

			intersection.normal.copy( intersects[0].face.normal );
			mouseHelper.lookAt( n );

			var positions = line.geometry.attributes.position;
			positions.setXYZ( 0, p.x, p.y, p.z );
			positions.setXYZ( 1, n.x, n.y, n.z );
			positions.needsUpdate = true;

			intersection.intersects = true;

			intersects.length = 0;

		} else {
			intersection.intersects = false;
		}
	}

	function loadSTL( file,decalMapArr ) {
		// ASCII file
		if (file) {
			file = file;
		} else {
			file = './models/stl/ascii/grey.stl';
		}
		// file = '';
		var loader = new THREE.STLLoader();
		loader.load( file, function ( geometry ) {
			var material = new THREE.MeshPhongMaterial( { color: 0x9B9EA1 } );
			mesh = new THREE.Mesh( geometry, material );
			//position
			mesh.position.set( 0, 0, 0 );
			mesh.rotation.set( 1.6, 0, 0);
			mesh.scale.set( .08, .08, .08 );
			mesh.castShadow = true;
			mesh.receiveShadow = true;
			scene.add( mesh );
			if(decalMapArr.length>0){
				for (var i in decalMapArr){
					scene.add( decalMapArr[i] );
				}
			}
			var currentscale = params.maxScale;
			currentSize.set( currentscale, currentscale, currentscale );
			var currentmaterial = decalMaterial.clone();
			mouseHelper= new THREE.Mesh( new THREE.DecalGeometry(mesh, position, orientation, currentSize ), currentmaterial );
			scene.add( mouseHelper );
			setTimeout(function () {
				$(".activeDecal").trigger("click"); //激活鼠标首次decal显示
			},200)
		} );
	}

	function shoot(type,lastRotation,lastPosition) { //type:0 第一次点击 1，旋转贴图
		// 当前选择贴图替换
		var sameImgNum=0;
		for(var i in recentlyUsedDecal){
			if(recentlyUsedDecal[i] == currentDecal){
				sameImgNum++;
			}
		}
		if(sameImgNum == 0){
			recentlyUsedDecal.push(currentDecal);
		}

		// 当前选择贴图替换end
		if(type==1){
			position.copy( lastPosition );
			orientation.copy( lastRotation);
		}
		else{
			position.copy( intersection.point );
			orientation.copy( mouseHelper.rotation );
			lastShootPostion = position;
			lastShootrotation =orientation;
		}
		// if ( params.rotate ) orientation.z = Math.random() * 2 * Math.PI;

		var scale = params.maxScale;
		size.set( scale, scale, scale );
		var material = decalMaterial.clone();

		var m = new THREE.Mesh( new THREE.DecalGeometry( mesh, position, orientation, size ), material );
		decals.push( m );
		currentDecalObj = decals;
		scene.add( m );
		if(decals.length>0){
			if(decals.length>0){
				$(".back_btn").addClass("active_back")
			}
		}
		createMap("recently_wrapper",recentlyUsedDecal);

		// 恢复操作rotation，否则报错
		$(".rotation").removeClass("rotation_cover");
		$(".rotation div:eq(0)").removeClass("rotation_no");
		$(".rotation").find("input").removeClass("input_no");
	}

	function animate() {

		requestAnimationFrame( animate );

		renderer.render( scene, camera );

		// stats.update();

	}
	function onWindowResize() {

		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();

		renderer.setSize( window.innerWidth, window.innerHeight );

	}

	function removeDecals() {

		decals.forEach( function ( d ) {
			clearCache(d);
			scene.remove( d );

		} );

		decals = [];
		removedDecals = [];
		$(".back_btn").removeClass("active_back");
		$(".forward_btn").removeClass("active_forward");
	}

	function removeLastDecals() {
		if (decals[decals.length - 1]) {
			clearCache(decals[decals.length - 1]);
			scene.remove( decals[decals.length - 1] );
			removedDecals.push( decals[decals.length - 1] );
			decals.pop();
		}
		if(decals.length>0){
			$(".back_btn").removeClass("active_back").addClass("active_back"); //目前decals数组不为空
		}
		else{
			$(".back_btn").removeClass("active_back"); //目前decals数组为空
		}
		if(removedDecals.length>0){ //已撤回的数组是否为空
			$(".forward_btn").removeClass("active_forward").addClass("active_forward"); //目前decals数组不为空
		}
		else{
			$(".forward_btn").removeClass("active_forward"); //目前decals数组为空
		}
	}

	function returnLastDecals() {
		if (removedDecals[removedDecals.length-1]) {
			decals.push( removedDecals[removedDecals.length-1] );
			scene.add( removedDecals[removedDecals.length-1] );
			removedDecals.pop();
		}
		if(decals.length>0){
			$(".back_btn").removeClass("active_back").addClass("active_back"); //目前decals数组不为空
		}
		else{
			$(".back_btn").removeClass("active_back"); //目前decals数组为空
		}
		if(removedDecals.length>0){
			$(".forward_btn").removeClass("active_forward").addClass("active_forward"); //目前decals数组不为空
		}
		else{
			$(".forward_btn").removeClass("active_forward"); //目前decals数组为空
		}
	}
	// 导出相关
	function exportASCII() {
		var result = exporter.parse( mesh );
		var date= Date.parse(new Date());
		saveString( result, date+'.stl' );
	}

	function exportBinary() {
		var result = exporter.parse( mesh, { binary: true } );
		var date= new Date();
		saveArrayBuffer( result,  date+'.stl' );

	}
	var link = document.createElement( 'a' );
	link.style.display = 'none';
	document.body.appendChild( link );

	function save( blob, filename ) {

		link.href = URL.createObjectURL( blob );
		link.download = filename;
		link.click();

	}
	function saveString( text, filename ) {

		save( new Blob( [ text ], { type: 'text/plain' } ), filename );

	}

	function saveArrayBuffer( buffer, filename ) {

		save( new Blob( [ buffer ], { type: 'application/octet-stream' } ), filename );

	}
	// 导出相关 end
	function changeCurrentDecal(obj){
		// return function(obj){
		// console.log(img);
		$(".each_decal").removeClass("activeDecal");
		// $(obj).siblings().removeClass("activeDecal");
		$(obj).addClass("activeDecal");
		var img = $(obj).find("img").attr("src");

		currentDecal = img;
		decalDiffuse = textureLoader.load( currentDecal );
		decalNormal =  textureLoader.load( currentDecal );
		decalMaterial = new THREE.MeshPhongMaterial( {
			specular: 0x444444,
			map: decalDiffuse,
			normalMap: decalNormal,
			normalScale: new THREE.Vector2( 1, 1 ),
			shininess: 30,
			transparent: true,
			depthTest: true,
			depthWrite: false,
			polygonOffset: true,
			polygonOffsetFactor: - 4,
			wireframe: false
		} );
		// 改变鼠标decal
		var currentscale = params.maxScale;
		currentSize.set( currentscale, currentscale, 30 );
		currentmaterial = decalMaterial.clone();
		position.set(0, 0, 0);
		clearCache(mouseHelper);
		scene.remove(mouseHelper);
		mouseHelper= new THREE.Mesh( new THREE.DecalGeometry( mesh, currentPosition, orientation, currentSize ), currentmaterial );
		scene.add(mouseHelper)
		// 改变鼠标decal end
	}

	function createMap(id,arr) {  //展示贴图，并赋予点击事件
		var reveseHTML =''
		var reverseArr =[];
		if(id=="recently_wrapper"){
			if(arr.length > 0){
				$(".no_recently").remove();
				for(var i in arr){
					reverseArr.push(arr[i])
				}
				reverseArr=reverseArr.reverse();
			}
		}
		else{
			reverseArr = arr;
			reveseHTML+=""
		}
		for ( var m in reverseArr ) {
			var eachDecal;
			if(m==1 && id=="map_wrapper"){
				eachDecal = '<div class="each_decal activeDecal" onclick="changeCurrentDecal(this)"><img src="'+reverseArr[m]+'" alt=""></div>';

			}
			else{
				eachDecal = '<div class="each_decal" onclick="changeCurrentDecal(this)"><img src="'+reverseArr[m]+'" alt=""></div>';
			}
			reveseHTML+=eachDecal;
		}
		$("#"+id).html(reveseHTML)
	}
	function uploadMap(file){ //上传图片
		if(file.length>1){
			alert('Please drag only one image.');
			document.getElementById('upload_input').value = null;
			return false;
		}
		if(file[0].type.indexOf("png")>-1){}else{
			alert('File ' + file[0].name + ' is not a image(only support png).');
			document.getElementById('upload_input').value = null;
			return false;
		}
		if ((file[0].size)/1024 > 8192) {
			alert('File size need less than 8M');
			document.getElementById('upload_input').value = null;
			return false;
		}
		else{

			var imgsrc; //上传图片，并创建url
			if(window.webkitURL){
				imgsrc=window.webkitURL.createObjectURL(file[0]);
			}
			else if(window.URL){
				imgsrc=window.URL.createObjectURL(file[0])
			}
			else{
				var reader = new FileReader();
				reader.onload = function(e) {
					imgsrc=e.target.result;
				}
				reader.readAsDataURL(file[0]);
			}
			var uploadHTML = '<div class="each_decal" onclick="changeCurrentDecal(this)"><img src="'+imgsrc+'" alt=""></div>';
			$("#map_wrapper").prepend(uploadHTML);
			$("#map_wrapper .each_decal:eq(0)").trigger("click");//默认选中
		}
	}
	function getCanvasBase64(img) {
		var image = new Image();
		//至关重要
		image.crossOrigin = '';
		image.src = img;
		//至关重要
		var deferred = $.Deferred();
		if (img) {
			image.onload = function () {
				deferred.resolve(getBase64Image(image));//将base64传给done上传处理
				// document.getElementById("CanvasImg").appendChild(image);
			}
			return deferred.promise();//问题要让onload完成后再return sessionStorage['imgTest']
		}
	}
	//width、height调用时传入具体像素值，控制大小 ,不传则默认图像大小
	function getBase64Image(img, width, height) {
		var canvas = document.createElement("canvas");
		canvas.width = width ? width : img.width;
		canvas.height = height ? height : img.height;
		var ctx = canvas.getContext("2d");
		ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
		var dataURL = canvas.toDataURL();
		return dataURL;
	}
	//End：

	function updateDecalTransform() { //旋转decal  移除原有的，改变角度，再shoot到原位置
		var lastDecal = decals[decals.length - 1];
		scene.remove(lastDecal);
		lastShootrotation.z=params.rotation/60;
		shoot(1,lastShootrotation,lastShootPostion);
	}

	function updateDecalSize() { //改变decal大小
		// 改变鼠标decal
		var currentscale = params.maxScale;
		currentSize.set( currentscale, currentscale,30 );
		currentmaterial = decalMaterial.clone();
		clearCache(mouseHelper);
		scene.remove(mouseHelper);
		mouseHelper= new THREE.Mesh( new THREE.DecalGeometry( mesh, currentPosition, orientation, currentSize ), currentmaterial );
		scene.add(mouseHelper)
		// 改变鼠标decal end
	}

	function initGUI(){
		var gui = new dat.GUI();
		gui.add( params, 'SUBMIT' );
		// gui.add( params, 'minScale', 1, 30 );
		gui.add( params, 'maxScale', 1, 30 ).name( 'maxScale' ).onChange( updateDecalSize );
		gui.add( params, 'rotation', -180, 180).name( 'rotation' ).onChange( updateDecalTransform ); //.name( 'rotation' ).onChange( updateDecalTransform )
		gui.add( params, 'back' );
		gui.add( params, 'forward' );
		gui.add( params, 'clear' );
		gui.open();
		$(".dg ul li:nth-of-type(1)").addClass("exportSTL");
		$(".dg ul li:nth-of-type(2)").addClass("decal_size");
		$(".dg ul li:nth-of-type(3)").addClass("rotation");
		$(".dg ul li:nth-of-type(4)").addClass("back_btn");
		$(".dg ul li:nth-of-type(5)").addClass("forward_btn");
		// 首次禁止操作rotation，否则报错
		$(".rotation").find(".property-name").text("rotation( -180°- 180° )");
		$(".rotation").addClass("rotation_cover");
		$(".rotation div:eq(0)").addClass("rotation_no");
		$(".rotation").find("input").addClass("input_no");
		// 首次禁止操作rotation，否则报错 end

	}
	/**
	 * 清空当前obj对象的缓存
	 * @param mesh  mesh对象
	 * */
	function clearCache(currentMesh) {
		currentMesh.geometry.dispose();
		currentMesh.material.dispose();
	}
</script>

</body>
</html>
